---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
library(readxl)
library(survey)
library(srvyr)
```

```{r}
nychvs <- read_rds("../../data/output/nychvs/nychvs2017.rds")
nyc311 <- read_rds("../../data/output/nyc311/02-nyc311_complaintXsubboro.rds")
pumas <- read_excel("../../data/input/linking/nyc_puma_neighborhood.xls")
```

create an aptotriate design object that contains the data variables and the replication weights metadata needed for valid estimation
```{r}
svy <- svrepdesign(variables = nychvs[ ,seq(19)], 
                    repweights = nychvs[ ,paste0("FW", seq(80))],
                    weights = ~hhweight,
                    combined.weights=TRUE,
                    type="Fay",
                    rho = (1-1/sqrt(4)),
                    scale = 4/80,
                    rscales = rep(1,80),
                    data = nychvs) %>%
      as_survey_rep()
```

```{r}
alpha <- .05/(nrow(pumas)*7)
zscore <- qnorm(1-alpha/2)
```

```{r issue_stairway}
obj <-
svy %>%
filter(renter, issue_stairway) %>%
mutate(geo_id2 = as.factor(geo_id2)) %>%
group_by(geo_id2) %>%
summarise(tot = survey_total(issue_stairway)) %>%
mutate(lower = tot-zscore*tot_se,
       upper = tot+zscore*tot_se) %>%
full_join(nyc311, by = "geo_id2") %>%
select(geo_id2, contains("stair"), contains("tot"), lower, upper) %>%
mutate(same = issue_stairway >= lower & issue_stairway <= upper,
       how_diff = case_when(issue_stairway < lower ~ "less_problems",
                            issue_stairway > upper ~ "more_problems")) %>%
filter(same == FALSE | is.na(same)) %>%
left_join(pumas, by = c("geo_id2" = "PUMA5ID"))

table(obj$how_diff, useNA = "ifany")
```

```{r issue_floors}
obj <-
svy %>%
filter(renter, issue_floors) %>%
mutate(geo_id2 = as.factor(geo_id2)) %>%
group_by(geo_id2) %>%
summarise(floors_tot = survey_total(issue_floors)) %>%
mutate(lower = floors_tot-zscore*floors_tot_se,
       upper = floors_tot+zscore*floors_tot_se) %>%
full_join(nyc311, by = "geo_id2") %>%
select(geo_id2, contains("floors"), lower, upper) %>%
mutate(same = issue_floors >= lower & issue_floors <= upper,
       how_diff = case_when(issue_floors < lower ~ "less_problems",
                            issue_floors > upper ~ "more_problems")) %>%
filter(same == FALSE | is.na(same)) %>%
left_join(pumas, by = c("geo_id2" = "PUMA5ID"))

table(obj$how_diff, useNA = "ifany")
```

```{r issue_toilet}
obj <-
svy %>%
filter(renter, issue_toilet) %>%
mutate(geo_id2 = as.factor(geo_id2)) %>%
group_by(geo_id2) %>%
summarise(tot = survey_total(issue_toilet)) %>%
mutate(lower = tot-zscore*tot_se,
       upper = tot+zscore*tot_se) %>%
full_join(nyc311, by = "geo_id2") %>%
select(geo_id2, contains("toilet"), contains("tot"), lower, upper) %>%
mutate(same = issue_toilet >= lower & issue_toilet <= upper,
       how_diff = case_when(issue_toilet < lower ~ "less_problems",
                            issue_toilet > upper ~ "more_problems")) %>%
filter(same == FALSE | is.na(same)) %>%
left_join(pumas, by = c("geo_id2" = "PUMA5ID"))

table(obj$how_diff, useNA = "ifany")
```

```{r issue_heat}
obj <-
svy %>%
filter(renter, issue_heat) %>%
mutate(geo_id2 = as.factor(geo_id2)) %>%
group_by(geo_id2) %>%
summarise(tot = survey_total(issue_toilet)) %>%
mutate(lower = tot-zscore*tot_se,
       upper = tot+zscore*tot_se) %>%
full_join(nyc311, by = "geo_id2") %>%
select(geo_id2, contains("heat"), contains("tot"), lower, upper) %>%
mutate(same = issue_heat >= lower & issue_heat <= upper,
       how_diff = case_when(issue_heat < lower ~ "less_problems",
                            issue_heat > upper ~ "more_problems")) %>%
filter(same == FALSE | is.na(same)) %>%
left_join(pumas, by = c("geo_id2" = "PUMA5ID"))

table(obj$how_diff, useNA = "ifany")
```

```{r issue_pests}
obj <-
svy %>%
filter(renter, issue_pests) %>%
mutate(geo_id2 = as.factor(geo_id2)) %>%
group_by(geo_id2) %>%
summarise(tot = survey_total(issue_pests)) %>%
mutate(lower = tot-zscore*tot_se,
       upper = tot+zscore*tot_se) %>%
full_join(nyc311, by = "geo_id2") %>%
select(geo_id2, contains("pests"), contains("tot"), lower, upper) %>%
mutate(same = issue_pests >= lower & issue_pests <= upper,
       how_diff = case_when(issue_pests < lower ~ "less_problems",
                            issue_pests > upper ~ "more_problems")) %>%
filter(same == FALSE | is.na(same)) %>%
left_join(pumas, by = c("geo_id2" = "PUMA5ID"))

table(obj$how_diff, useNA = "ifany")
```

```{r issue_plasterpaint}
obj <-
svy %>%
filter(renter, issue_plasterpaint) %>%
mutate(geo_id2 = as.factor(geo_id2)) %>%
group_by(geo_id2) %>%
summarise(tot = survey_total(issue_pests)) %>%
mutate(lower = tot-zscore*tot_se,
       upper = tot+zscore*tot_se) %>%
full_join(nyc311, by = "geo_id2") %>%
select(geo_id2, contains("paint"), contains("tot"), lower, upper) %>%
mutate(same = issue_plasterpaint >= lower & issue_plasterpaint <= upper,
       how_diff = case_when(issue_plasterpaint < lower ~ "less_problems",
                            issue_plasterpaint > upper ~ "more_problems")) %>%
filter(same == FALSE | is.na(same)) %>%
left_join(pumas, by = c("geo_id2" = "PUMA5ID"))

table(obj$how_diff, useNA = "ifany")
```

```{r issue_leak}
obj <-
svy %>%
filter(renter, issue_leak) %>%
mutate(geo_id2 = as.factor(geo_id2)) %>%
group_by(geo_id2) %>%
summarise(tot = survey_total(issue_leak)) %>%
mutate(lower = tot-zscore*tot_se,
       upper = tot+zscore*tot_se) %>%
full_join(nyc311, by = "geo_id2") %>%
select(geo_id2, contains("leak"), contains("tot"), lower, upper) %>%
mutate(same = issue_leak >= lower & issue_leak <= upper,
       how_diff = case_when(issue_leak < lower ~ "less_problems",
                            issue_leak > upper ~ "more_problems")) %>%
filter(same == FALSE | is.na(same)) %>%
left_join(pumas, by = c("geo_id2" = "PUMA5ID"))

table(obj$how_diff, useNA = "ifany") 
```


